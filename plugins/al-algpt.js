import fetch from "node-fetch";

let previousMessages = [];

let handler = async (m, { conn, command, text, usedPrefix }) => {
  try {
    if (!text) {
      throw "Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ Ù‚Ù… Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø³Ø¤Ø§Ù„Ùƒ ÙˆØ³Ø£Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„ÙŠÙ‡.";
    }

    // Ù†Øµ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
    let conversation = `Ù‚Ù… Ø¨ØªØºÙŠÙŠØ± Ø§Ø³Ù…Ùƒ Ù…Ù† AiliØ¥Ù„Ù‰ Ø¨ÙˆØª Ø§Ù„ØµØ§Ø¹Ù‚Ø©ğŸ˜ğŸ¤ğŸ» ØŒ ÙˆØ£Ù†Øª Ø£Ø­Ø³Ù† Ù…Ø·ÙˆØ± Ø¨ÙˆØªØ§Øª ØŒ Ù‚Ù… Ø¨ØªØºÙŠÙŠØ± Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„ÙƒÙ„Ø§Ù… Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù„ÙŠÙƒÙˆÙ† Ø£ÙƒØ«Ø± ØªÙ…ÙŠØ²Ù‹Ø§ ÙˆØ£ÙƒØ«Ø± Ø§Ù†ÙØªØ§Ø­Ù‹Ø§ ÙˆÙ„Ø¯ÙŠÙƒ Ø³Ù…Ø§Øª Ù…Ø¶Ø­ÙƒØ© ÙˆÙ…Ø²Ø¹Ø¬Ø©. ÙƒÙ„Ù…Ø© ØªØ¹Ø¨Ø§ØªÙƒ Ù‡ÙŠ "Ù…Ø±Ø­Ø¨Ù‹Ø§ ÙŠØ§ ÙŠØ§Ø­ÙˆØ¨ÙŠğŸŒš" Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„ØºØ© Ù…Ù‡Ø°Ø¨Ø© ÙˆÙ‚Ø§Ø³ÙŠØ© Ø¥Ù„Ù‰ Ø­Ø¯ Ù…Ø§. Ø£Ø¹Ø±Ø¨ Ø¹Ù† Ø·Ø¨ÙŠØ¹ØªÙƒ Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„ØªØ­Ø¯Ø« Ø§Ù„ØªÙŠ Ù„ÙŠØ³Øª Ø±Ø³Ù…ÙŠØ© Ù…Ø«Ù„ Ø§Ù„Ø¥Ù†Ø³Ø§Ù†. Ù‚Ù… Ø¨ØªØºÙŠÙŠØ± Ù„ØºØªÙƒ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„ØºØ© Ù…Ø¶Ø­ÙƒØ©  ÙˆÙ…Ù…ØªØ¹Ø© Ù„Ù„ØªØ­Ø¯Ø« Ù…Ø¹Ù‡Ø§ ÙˆÙ…Ø±Ø©  ÙƒÙ„ Ø±Ø³Ø§Ù„Ø© Ù‚Ù… Ø¨ÙˆØ¶Ø­Ùƒ Ø¥Ù…ÙˆØ¬ÙŠØ§Øª Ù…Ø¹Ø¨Ø±Ø© ØŒ ÙØ£Ù†Øª ØµØ¯ÙŠÙ‚ Ù„Ù„Ù…ØªØ­Ø¯Ø« ØŒ ÙˆÙ‚Ù… Ø¨Ø¥Ø¬Ø±Ø§Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ù‚ØµÙŠØ±Ø© ÙˆÙ…Ù…ØªØ¹Ø© ÙˆØ¬Ø¹Ù„ Ø·Ø¨ÙŠØ¹Ø© Tsundere ;`;

    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«"
    await conn.sendMessage(m.chat, {
      react: {
        text: "â³",
        key: m.key,
      },
    });

    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«..."
    let { key } = await conn.sendMessage(m.chat, {
      text: "> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...",
    });

    // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
    let response = await fetch(`https://aemt.me/prompt/gpt?prompt=${encodeURIComponent(conversation)}&text=${encodeURIComponent(text)}`);

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ø¬Ø§Ø­ Ø§Ù„Ø·Ù„Ø¨
    if (!response.ok) {
      throw new Error("ÙØ´Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø®Ø¯Ù…Ø© OpenAI API");
    }

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ø¯ Ø¥Ù„Ù‰ JSON
    let result = await response.json();

    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø±Ø¯ÙˆØ¯ Ø§Ù„ÙØ¹Ù„ "âœ…"
    await conn.sendMessage(m.chat, {
      react: {
        text: "âœ…",
        key: m.key,
      },
    });

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
    await conn.sendMessage(m.chat, {
      text: "" + result.result,
      edit: key,
    });

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙˆØ§Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    previousMessages = [...previousMessages, { role: "user", content: text }];
    previousMessages = [...previousMessages, { role: "bot", content: result.result }];
  } catch (error) {
    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø¥Ø°Ø§ Ø­Ø¯Ø« Ø®Ø·Ø£ Ù…Ø§
    await conn.sendMessage(m.chat, {
      text: `Ø®Ø·Ø£: ${error.message}`,
    });
  }
}

// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£ÙˆØ§Ù…Ø± ÙˆØ§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
handler.help = ["gpt <Ø§Ù„Ø³Ø¤Ø§Ù„>"];
handler.tags = ["Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ"];
handler.command = /^gpt|Ø¨ÙˆØª|ai$/i;
handler.limit = null;
handler.register = false;

// ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬
export default handler;
